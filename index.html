<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hor√°rios Livres-IC's do NIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-btn { transition: all 0.2s; }
        .slot-btn:hover { transform: scale(1.05); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Hor√°rios Livres-ICs do NIP</h1>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="studentCount">Carregando...</span>
                </div>
            </div>
        </header>
        <div id="mainContent">
            <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                <p class="text-gray-600">Carregando sistema...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCK0HEL7gDiwwuWoVXhYGbqYWebQFBxnqo",
            authDomain: "horarios-ics-nip.firebaseapp.com",
            projectId: "horarios-ics-nip",
            storageBucket: "horarios-ics-nip.firebasestorage.app",
            messagingSenderId: "284125156520",
            appId: "1:284125156520:web:aa4aa48fb11456eb925e9d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let students = [];
        let editingStudentId = null;
        let isLoading = true;
        let selectedDay = 'all';
        let selectedPeriod = 'all';
        let selectedAdvisor = 'all';
        let minStudents = 1;

        const timeSlots = {
            morning: ['08:00-08:50', '08:50-09:40', '10:00-10:50', '10:50-11:40', '11:40-12:30', '12:30-13:20'],
            afternoon: ['13:30-14:20', '14:20-15:10', '15:10-16:00', '16:00-16:50', '17:10-18:00', '18:00-18:50'],
            night: ['19:00-19:50', '19:50-20:40', '20:40-21:30', '21:30-22:20', '22:20-23:10']
        };
        const days = ['Segunda', 'Terca', 'Quarta', 'Quinta', 'Sexta'];
        const periodNames = { morning: 'Manh√£', afternoon: 'Tarde', night: 'Noite' };

        async function saveStudent(student) {
            const data = { 
                name: student.name || '', 
                course: student.course || '', 
                advisor: student.advisor || '',
                schedule: student.schedule || {}, 
                updatedAt: new Date().toISOString() 
            };
            if (student.firestoreId) {
                await updateDoc(doc(db, 'students', student.firestoreId), data);
            }
        }

        function isSlotOccupied(student, day, period, slot) {
            return student.schedule?.[day]?.[period]?.includes(slot) || false;
        }

        function calculateFreeSlots() {
            let free = [];
            // Filtra os alunos pelo orientador antes de calcular os hor√°rios livres
            const filteredStudents = selectedAdvisor === 'all' 
                ? students 
                : students.filter(s => s.advisor === selectedAdvisor);

            days.forEach(day => {
                Object.keys(timeSlots).forEach(period => {
                    timeSlots[period].forEach(slot => {
                        let available = filteredStudents.filter(s => !isSlotOccupied(s, day, period, slot));
                        if (available.length >= minStudents) {
                            free.push({ day, period, slot, count: available.length, students: available });
                        }
                    });
                });
            });
            return free.sort((a, b) => b.count - a.count);
        }

        function render() {
            const container = document.getElementById('mainContent');
            const counter = document.getElementById('studentCount');
            if (counter) counter.textContent = `${students.length} alunos cadastrados`;

            if (isLoading) return;

            // Pega lista √∫nica de orientadores para o filtro
            const advisors = [...new Set(students.map(s => s.advisor).filter(a => a))].sort();

            let html = `<div class="space-y-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Alunos Cadastrados</h2>
                        <div class="flex gap-2">
                            <button onclick="window.addStudent()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-medium">+ Adicionar</button>
                            <button onclick="window.clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-medium">Limpar Tudo</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

            students.forEach(s => {
                const isEditing = editingStudentId === s.id;
                html += `
                    <div class="border-2 ${isEditing ? 'border-indigo-400 ring-2 ring-indigo-100' : 'border-gray-100'} rounded-xl p-4 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <input type="text" value="${s.name}" onchange="window.updateStudent('${s.id}', 'name', this.value)" placeholder="Nome do Aluno" class="w-full font-bold text-gray-800 border-b border-transparent focus:border-indigo-300 outline-none mb-1">
                                <input type="text" value="${s.course}" onchange="window.updateStudent('${s.id}', 'course', this.value)" placeholder="Curso" class="w-full text-sm text-gray-500 border-b border-transparent focus:border-indigo-300 outline-none mb-1">
                                <input type="text" value="${s.advisor || ''}" onchange="window.updateStudent('${s.id}', 'advisor', this.value)" placeholder="Orientador" class="w-full text-xs text-indigo-600 font-medium border-b border-transparent focus:border-indigo-300 outline-none">
                            </div>
                            <button onclick="window.removeStudent('${s.id}')" class="text-red-400 hover:text-red-600 ml-2">üóë</button>
                        </div>
                        <button onclick="window.toggleEditing('${s.id}')" class="w-full mt-3 py-2 rounded-lg text-sm font-semibold ${isEditing ? 'bg-green-100 text-green-700' : 'bg-indigo-50 text-indigo-700'}">
                            ${isEditing ? '‚úì Concluir' : '‚úé Editar Hor√°rios'}
                        </button>
                    </div>`;
            });

            html += `</div></div>`;

            if (editingStudentId) {
                const s = students.find(x => x.id === editingStudentId);
                if (s) {
                    html += `<div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">Editando Hor√°rios: ${s.name || 'Novo Aluno'}</h2>
                        <div class="grid grid-cols-5 gap-4 overflow-x-auto pb-4" style="min-width: 800px;">`;
                    days.forEach(day => {
                        html += `<div class="space-y-4"><h3 class="font-bold text-center bg-gray-50 py-2 rounded">${day}</h3>`;
                        Object.keys(timeSlots).forEach(p => {
                            html += `<div><p class="text-xs font-bold text-gray-400 mb-2 uppercase">${periodNames[p]}</p><div class="space-y-1">`;
                            timeSlots[p].forEach(slot => {
                                const occ = isSlotOccupied(s, day, p, slot);
                                html += `<button onclick="window.toggleSlot('${s.id}','${day}','${p}','${slot}')" class="w-full py-1 text-xs rounded font-medium ${occ ? 'bg-red-500 text-white' : 'bg-green-100 text-green-800'}">${slot}</button>`;
                            });
                            html += `</div></div>`;
                        });
                        html += `</div>`;
                    });
                    html += `</div></div>`;
                }
            }

            const free = calculateFreeSlots().filter(f => (selectedDay === 'all' || f.day === selectedDay) && (selectedPeriod === 'all' || f.period === selectedPeriod));
            
            html += `<div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-6 text-gray-800">Melhores Hor√°rios Livres</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div><label class="text-xs font-bold text-gray-500 block mb-2">Dia</label>
                        <select onchange="window.changeDay(this.value)" class="w-full border p-2 rounded-lg">${['all', ...days].map(d => `<option value="${d}" ${selectedDay === d ? 'selected' : ''}>${d === 'all' ? 'Todos os dias' : d}</option>`).join('')}</select>
                    </div>
                    <div><label class="text-xs font-
