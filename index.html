<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hor√°rios Livres-IC's do NIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-btn { transition: all 0.2s; }
        .slot-btn:hover { transform: scale(1.05); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Hor√°rios Livres-ICs do NIP</h1>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="studentCount">Iniciando...</span>
                </div>
            </div>
        </header>
        <div id="mainContent">
            <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                <p class="text-gray-600">Conectando ao banco de dados...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCK0HEL7gDiwwuWoVXhYGbqYWebQFBxnqo",
            authDomain: "horarios-ics-nip.firebaseapp.com",
            projectId: "horarios-ics-nip",
            storageBucket: "horarios-ics-nip.firebasestorage.app",
            messagingSenderId: "284125156520",
            appId: "1:284125156520:web:aa4aa48fb11456eb925e9d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let students = [];
        let editingStudentId = null;
        let isLoading = true;
        let selectedDay = 'all';
        let selectedPeriod = 'all';
        let selectedAdvisor = 'all';
        let minStudents = 1;

        const timeSlots = {
            morning: ['08:00-08:50', '08:50-09:40', '10:00-10:50', '10:50-11:40', '11:40-12:30', '12:30-13:20'],
            afternoon: ['13:30-14:20', '14:20-15:10', '15:10-16:00', '16:00-16:50', '17:10-18:00', '18:00-18:50'],
            night: ['19:00-19:50', '19:50-20:40', '20:40-21:30', '21:30-22:20', '22:20-23:10']
        };
        const days = ['Segunda', 'Terca', 'Quarta', 'Quinta', 'Sexta'];
        const periodNames = { morning: 'Manh√£', afternoon: 'Tarde', night: 'Noite' };

        // --- FUN√á√ïES GLOBAIS ---
        window.addStudent = async () => {
            const docRef = await addDoc(collection(db, 'students'), { 
                name: '', course: '', advisor: '', schedule: {}, createdAt: new Date().toISOString() 
            });
            editingStudentId = docRef.id;
        };

        window.updateStudent = async (id, field, value) => {
            await updateDoc(doc(db, 'students', id), { [field]: value, updatedAt: new Date().toISOString() });
        };

        window.toggleEditing = id => { editingStudentId = editingStudentId === id ? null : id; render(); };

        window.toggleSlot = async (id, d, p, sl) => {
            const s = students.find(x => x.id === id);
            if (!s) return;
            let sched = s.schedule || {};
            if (!sched[d]) sched[d] = {};
            if (!sched[d][p]) sched[d][p] = [];
            const idx = sched[d][p].indexOf(sl);
            if (idx > -1) sched[d][p].splice(idx, 1);
            else sched[d][p].push(sl);
            await updateDoc(doc(db, 'students', id), { schedule: sched });
        };

        window.removeStudent = async id => { if (confirm('Remover aluno?')) await deleteDoc(doc(db, 'students', id)); };
        window.changeDay = v => { selectedDay = v; render(); };
        window.changePeriod = v => { selectedPeriod = v; render(); };
        window.changeAdvisor = v => { selectedAdvisor = v; render(); };
        window.changeMinStudents = v => { minStudents = parseInt(v) || 1; render(); };
        window.clearAllData = async () => {
            if (confirm('Apagar TUDO?')) {
                const snap = await getDocs(collection(db, 'students'));
                snap.forEach(async d => await deleteDoc(doc(db, 'students', d.id)));
            }
        };

        function isSlotOccupied(student, day, period, slot) {
            return student.schedule?.[day]?.[period]?.includes(slot) || false;
        }

        function render() {
            const container = document.getElementById('mainContent');
            const counter = document.getElementById('studentCount');
            if (counter) counter.textContent = `${students.length} alunos cadastrados`;
            if (isLoading && students.length === 0) return;

            const advisors = [...new Set(students.map(s => s.advisor).filter(a => a))].sort();
            const filteredForBest = selectedAdvisor === 'all' ? students : students.filter(s => s.advisor === selectedAdvisor);

            let html = `<div class="space-y-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Alunos</h2>
                        <div class="flex gap-2">
                            <button onclick="window.addStudent()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">+ Adicionar</button>
                            <button onclick="window.clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">Limpar Tudo</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

            students.forEach(s => {
                const isEditing = editingStudentId === s.id;
                html += `<div class="border-2 ${isEditing ? 'border-indigo-400' : 'border-gray-100'} rounded-xl p-4">
                    <input type="text" value="${s.name}" onchange="window.updateStudent('${s.id}','name',this.value)" placeholder="Nome" class="w-full font-bold border-b border-transparent focus:border-indigo-200 outline-none mb-1">
                    <input type="text" value="${s.course}" onchange="window.updateStudent('${s.id}','course',this.value)" placeholder="Curso" class="w-full text-sm border-b border-transparent focus:border-indigo-200 outline-none mb-1">
                    <input type="text" value="${s.advisor || ''}" onchange="window.updateStudent('${s.id}','advisor',this.value)" placeholder="Orientador" class="w-full text-xs text-indigo-600 border-b border-transparent focus:border-indigo-200 outline-none">
                    <div class="flex gap-2 mt-3">
                        <button onclick="window.toggleEditing('${s.id}')" class="flex-1 py-1 rounded text-xs font-bold ${isEditing ? 'bg-green-100 text-green-700' : 'bg-indigo-50 text-indigo-700'}">${isEditing ? '‚úì Concluir' : '‚úé Hor√°rios'}</button>
                        <button onclick="window.removeStudent('${s.id}')" class="px-2 text-red-300 hover:text-red-600">üóë</button>
                    </div>
                </div>`;
            });
            html += `</div></div>`;

            if (editingStudentId) {
                const s = students.find(x => x.id === editingStudentId);
                if (s) {
                    html += `<div class="bg-white rounded-lg shadow-lg p-6 overflow-x-auto">
                        <h2 class="font-bold mb-4">Editando: ${s.name || 'Novo'}</h2>
                        <div class="flex gap-4 min-w-[800px]">`;
                    days.forEach(day => {
                        html += `<div class="flex-1"><h3 class="text-center bg-gray-50 py-1 font-bold mb-2">${day}</h3>`;
                        Object.keys(timeSlots).forEach(p => {
                            html += `<p class="text-[10px] font-bold text-gray-400 uppercase mt-2">${periodNames[p]}</p>`;
                            timeSlots[p].forEach(slot => {
                                const occ = isSlotOccupied(s, day, p, slot);
                                html += `<button onclick="window.toggleSlot('${s.id}','${day}','${p}','${slot}')" class="w-full py-1 text-[10px] my-0.5 rounded ${occ ? 'bg-red-500 text-white' : 'bg-green-100'}">${slot}</button>`;
                            });
                        });
                        html += `</div>`;
                    });
                    html += `</div></div>`;
                }
            }

            html += `<div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-6">Hor√°rios Livres</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-sm">
                    <select onchange="window.changeDay(this.value)" class="border p-2 rounded-lg"><option value="all">Todos os dias</option>${days.map(d => `<option value="${d}" ${selectedDay === d ? 'selected' : ''}>${d}</option>`).join('')}</select>
                    <select onchange="window.changePeriod(this.value)" class="border p-2 rounded-lg"><option value="all">Todos os per√≠odos</option>${Object.entries(periodNames).map(([k,v]) => `<option value="${k}" ${selectedPeriod === k ? 'selected' : ''}>${v}</option>`).join('')}</select>
                    <select onchange="window.changeAdvisor(this.value)" class="border p-2 rounded-lg"><option value="all">Todos os Orientadores</option>${advisors.map(a => `<option value="${a}" ${selectedAdvisor === a ? 'selected' : ''}>${a}</option>`).join('')}</select>
                    <div class="flex items-center gap-2"><label class="whitespace-nowrap">M√≠n: ${minStudents}</label><input type="range" min="1" max="${Math.max(students.length, 1)}" value="${minStudents}" oninput="window.changeMinStudents(this.value)" class="w-full"></div>
                </div><div class="space-y-3">`;

            let free = [];
            days.forEach(day => { Object.keys(timeSlots).forEach(p => { timeSlots[p].forEach(slot => {
                let av = filteredForBest.filter(s => !isSlotOccupied(s, day, p, slot));
                if (av.length >= minStudents) free.push({ day, p, slot, count: av.length, students: av });
            }); }); });
            free.sort((a,b) => b.count - a.count).filter(f => (selectedDay === 'all' || f.day === selectedDay) && (selectedPeriod === 'all' || f.p === selectedPeriod)).forEach(f => {
                html += `<div class="border rounded-lg p-3"><div class="flex justify-between font-bold mb-2"><span>${f.day} ‚Ä¢ ${periodNames[f.p]} ‚Ä¢ ${f.slot}</span><span class="text-indigo-600">${f.count} Alunos</span></div><div class="flex flex-wrap gap-1">${f.students.map(s => `<span class="bg-green-50 text-green-700 px-2 py-0.5 rounded text-[10px]">${s.name}</span>`).join('')}</div></div>`;
            });

            html += `</div></div></div>`;
            container.innerHTML = html;
        }

        onSnapshot(collection(db, 'students'), (snap) => {
            students = snap.docs.map(d => ({ ...d.data(), id: d.id }));
            isLoading = false;
            render();
        });
    </script>
</body>
</html>
